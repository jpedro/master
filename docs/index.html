<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Master password</title>
<link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
<style>
body {
    max-width: 800px;
    margin: 40px auto;
}
input {
    padding: 5px;
    border-radius: 5px;
    margin: 5px 0;
    font-size: 1.2em;
    width: 700px; /* becomes 712px due to padding 2 x 5px + 2 x 1px border*/
    border: 1px solid #aaa;
}
#tips {
    padding: 5px;
    font-size: 1.2em;
}
code {
    background: #ddd;
    padding: 3px 5px;
    border-radius: 3px;
}
#hashed {
    background: #f7dc6f;
    --background: #fad7a0;
    padding: 20px;
    border-radius: 10px;
    font-size: 1.5em;
    --border: 4px solid #ccc;
    text-align: center;
    --display: none;
    --width: 672px; /* Plus 2 x 20px padding  */
    height: 2.5em;
    transition: background-color 0.05s ease;
    color: #000;
}
#hashed.new {
    background: #f1c40f;
}
#hashed.visible {
    background: #d35400;
    color: #fff;
}
</style>
</head>
<body>
<h1>Master password</h1>
<form onsubmit="generate(); return false;">
    <input
        type="password" id="username"
        placeholder="Master username" required
        autocomplete="off" value="pedro" /><br />
    <input
        type="password" id="password"
        placeholder="Master password" required
        autocomplete="off" /><br />
    <input
        type="text" name="value" id="value"
        placeholder="Service name" required
        autocomplete="off" autofocus />
</form>
<div id="tips">
    Press <code>enter</code> to copy the password
    and <code>alt</code> to reveal it.
</div>
<pre id="hashed"></pre>
<script>
const sha256 = async (message) => {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    const buffer = await crypto.subtle.digest("SHA-256", data);
    const bytes = Array.from(new Uint8Array(buffer));
    console.log("bytes  ", bytes);
    console.log("btoa   ", btoa(bytes));
    console.log("atob   ", btoa(buffer));
    const hex = bytes
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
    return hex;
};

const username = document.getElementById("username");
const password = document.getElementById("password");
const value    = document.getElementById("value");
const hashed   = document.getElementById("hashed");

let visible  = false;

const save = () => {
    localStorage.setItem("username", username.value);
    localStorage.setItem("password", password.value);
};

const load = () => {
    username.value = localStorage.getItem("username");
    password.value = localStorage.getItem("password");
};

const isKeyboardEmpty = (ev) => {
    return (
        ev.charCode === 0
        && ev.metaKey === false
        && ev.shiftKey === false
        && ev.ctrlKey === false
    )
}

const onKeyUp = (ev) => {
    // if (ev.keyCode === 18 && ev.charCode === 0 && ev.metaKey === false && ev.shiftKey === false && ev.ctrlKey === false) {
    if (ev.keyCode === 18 && isKeyboardEmpty(ev)) {
        console.log("ev.altKey", ev.altKey);
        return toggle(false);
    }
};

const onKeyDown = (ev) => {
    console.log("ev.keyCode", ev.keyCode);
    // console.log("ev", ev);
    // if (ev.keyCode === 27 && ev.charCode === 0 && ev.metaKey === false && ev.shiftKey === false && ev.ctrlKey === false) {
    // Escape
    if (ev.keyCode === 27 && isKeyboardEmpty(ev)) {
        return hide();
    }
    // if (ev.keyCode === 18 && ev.charCode === 0 && ev.metaKey === false && ev.shiftKey === false && ev.ctrlKey === false) {
    if (ev.keyCode === 18 && isKeyboardEmpty(ev)) {
        console.log("ev.altKey", ev.altKey);
        return toggle(true);
    }
    // if (ev.keyCode !== 13) {
    //     return console.log("onKeyPress: ev.keyCode", ev.keyCode);
    // }
    generate();
};

const generate = () => {
    save();
    const source = [username.value, password.value, value.value, 0].join(":");
    sha256(source)
        .then(hex => {
            console.log("source ", source);
            console.log("hex    ", hex);
            const encoded = btoa(hex);
            console.log("encoded", encoded);
            const regex = /[^0-9A-Za-z]/g;
            const replaced = encoded.replace(regex, "");
            console.log("replaced", replaced);
            const chunks = 6;
            const length = 6;
            let parts = [];
            for (let i = 0; i < chunks; i++) {
                parts.push(replaced.slice(i * length, (i + 1) * length));
            }
            console.log("parts", parts);
            const generated = parts.join("-");
            console.log("generated", generated);
            hashed.setAttribute("data-generated", generated);
            navigator.clipboard.writeText(generated);
            // hashed.innerText = "Password copied to clipboard";
            hashed.innerText = generated;
            hashed.style.display = "block";
            hashed.classList.add("new");
            // setTimeout(() => {
            //     hashed.classList.remove("new");
            // }, 200);
        })
        .catch(err => {
            console.error("err", err);
        })
    ;
};

const hide = () => {
    hashed.style.display =
        hashed.style.display === "block"
        ? "none"
        : "block";
}

const toggle = (state) => {
    if (state !== undefined) {
        visible = state;
    }

    if (visible) {
        hashed.innerText = hashed.getAttribute("data-generated");
        hashed.classList.add("visible");
    } else {
        hashed.innerText = "Password copied to clipboard";
        hashed.classList.remove("visible");
    }
    visible = !visible;
    // console.log("visible", visible);
};

document.onkeydown = onKeyDown;
document.onkeyup = onKeyUp;

load();
</script>
</body>
</html>
