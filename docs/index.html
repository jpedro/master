<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Testing in the browser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
code#hashed {
    background: #ffa;
    padding: 20px;
    border-radius: 10px;
    font-size: 2em;
    border: 4px solid #ccc;
}
</style>
</head>
<body>
<form onSubmit="return false;">
    <input
        type="text" id="username"
        placeholder="Your master username"
        autocomplete="off" value="pedro" /><br />
    <input
        type="password" id="password"
        placeholder="Your master password"
        autocomplete="off" /><br />
    <input
        type="text" name="value" id="value"
        placeholder="Your test goes here"
        autocomplete="off" autofocus />
</form>
<pre id="hashed"></pre>
<script>
const sha256 = async (message) => {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    const buffer = await crypto.subtle.digest("SHA-256", data);
    const bytes = Array.from(new Uint8Array(buffer));
    console.log("bytes  ", bytes);
    console.log("btoa   ", btoa(bytes));
    console.log("atob   ", btoa(buffer));
    const hex = bytes
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
    return hex;
};

const username = document.getElementById("username");
const password = document.getElementById("password");
const value    = document.getElementById("value");
const hashed   = document.getElementById("hashed");

username.addEventListener("keypress", ev => {
    generate(ev);
});
password.addEventListener("keypress", ev => {
    generate(ev);
});
value.addEventListener("keypress", ev => {
    generate(ev);
});

const save = () => {
    localStorage.setItem("username", username.value);
    localStorage.setItem("password", password.value);
};

const load = () => {
    username.value = localStorage.getItem("username");
    password.value = localStorage.getItem("password");
};

const generate = (ev) => {
    if (ev.keyCode != 13) {
        console.log("onKeyPress: ev.keyCode", ev.keyCode);
        return;
    }
    save();
    const source = [username.value, password.value, value.value, 0].join(":");
    sha256(source)
        .then(hex => {
            console.log("source ", source);
            console.log("hex    ", hex);
            const encoded = btoa(hex);
            console.log("encoded", encoded);
            const regex = /[^0-9A-Za-z]/g;
            const replaced = encoded.replace(regex, "");
            console.log("replaced", replaced);
            const chunks = 6;
            const length = 6;
            let parts = [];
            for (let i = 0; i < chunks; i++) {
                parts.push(replaced.slice(i * length, (i + 1) * length));
            }
            console.log("parts", parts);
            const password = parts.join("-");
            console.log("password", password);
            hashed.innerText = password;
        })
        .catch(err => {
            console.error("err", err);
        })
    ;
};
load();
</script>
</body>
</html>
