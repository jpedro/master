<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Master password</title>
<link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    max-width: 800px;
    margin: 40px auto;
}
input {
    padding: 5px;
    border-radius: 5px;
    margin: 5px 0;
    font-size: 1.2em;
    width: 700px;
    border: 1px solid #aaa;
}
#hashed {
    background: #ffa;
    padding: 20px;
    border-radius: 10px;
    font-size: 2em;
    border: 4px solid #ccc;
    text-align: center;
    display: none;
}
</style>
</head>
<body>
<h1>Master password</h1>
<form onsubmit="generate(); return false;">
    <input
        type="text" id="username"
        placeholder="Master username"
        autocomplete="off" value="pedro" /><br />
    <input
        type="password" id="password"
        placeholder="Master password"
        autocomplete="off" /><br />
    <input
        type="text" name="value" id="value"
        placeholder="Service name"
        autocomplete="off" autofocus />
</form>
<pre id="hashed"></pre>
<script>
const sha256 = async (message) => {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    const buffer = await crypto.subtle.digest("SHA-256", data);
    const bytes = Array.from(new Uint8Array(buffer));
    console.log("bytes  ", bytes);
    console.log("btoa   ", btoa(bytes));
    console.log("atob   ", btoa(buffer));
    const hex = bytes
        .map(b => b.toString(16).padStart(2, "0"))
        .join("");
    return hex;
};

const username = document.getElementById("username");
const password = document.getElementById("password");
const value    = document.getElementById("value");
const hashed   = document.getElementById("hashed");
const visible  = false;

// username.addEventListener("keypress", ev => {
//     generate(ev);
// });
// password.addEventListener("keypress", ev => {
//     generate(ev);
// });
// value.addEventListener("keypress", ev => {
//     generate(ev);
// });
const save = () => {
    localStorage.setItem("username", username.value);
    localStorage.setItem("password", password.value);
};

const load = () => {
    username.value = localStorage.getItem("username");
    password.value = localStorage.getItem("password");
};

const onKeyUp = (ev) => {
    console.log("ev", ev);
    if (ev.keyCode === 18 && ev.charCode === 0) {
        toggle();
        return;
    }
    if (ev.keyCode !== 13) {
        console.log("onKeyPress: ev.keyCode", ev.keyCode);
        return;
    }
    generate();
};

const generate = () => {
    save();
    const source = [username.value, password.value, value.value, 0].join(":");
    sha256(source)
        .then(hex => {
            console.log("source ", source);
            console.log("hex    ", hex);
            const encoded = btoa(hex);
            console.log("encoded", encoded);
            const regex = /[^0-9A-Za-z]/g;
            const replaced = encoded.replace(regex, "");
            console.log("replaced", replaced);
            const chunks = 6;
            const length = 6;
            let parts = [];
            for (let i = 0; i < chunks; i++) {
                parts.push(replaced.slice(i * length, (i + 1) * length));
            }
            console.log("parts", parts);
            const generated = parts.join("-");
            console.log("generated", generated);
            hashed.setAttribute("data-generated", generated);
            navigator.clipboard.writeText(generated);
            hashed.innerText = "Password copied to clipboard";
            hashed.style.display = "block";
        })
        .catch(err => {
            console.error("err", err);
        })
    ;
};

const toggle = () => {
    // if (hashed.style.display === "block") {
    //     hashed.style.display = "none";
    // } else {
    //     hashed.style.display = "block";
    // }
    if (visible) {
        hashed.innerText = "Password copied to clipboard";
    } else {
        hashed.innerText = hashed.getAttribute("data-generated");
        setTimeout(toggle, 2000);
    }
    visible = !visible;
};

document.onkeyup = onKeyUp;

load();
</script>
</body>
</html>
