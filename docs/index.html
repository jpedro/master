<!DOCTYPE html>
<html data-theme="light">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Master password</title>
<link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>">
<link rel="stylesheet" href="https://unpkg.com/@picocss/pico@1.*/css/pico.min.css">
<style>
body {
    max-width: 800px;
    margin: 40px auto;
}
form {
    margin: 0;
    padding: 0;
}
input {
    padding: 5px;
    border-radius: 5px;
    margin: 5px 0;
    font-size: 1.2em;
    width: 700px; /* becomes 712px due to padding 2 x 5px + 2 x 1px border*/
    border: 1px solid #aaa;
}
#tips {
    margin: 20px 0;
    padding: 5px;
    font-size: 1.2em;
}
code {
    margin: 0 5px;
    padding: 5px 10px;
    background: #ddd;
    color: #000;
    border-radius: 3px;
}
#result {
    background: #f7dc6f;
    ---background: #fad7a0;
    padding: 20px;
    border-radius: 10px;
    font-size: 1.5em;
    ---border: 4px solid #ccc;
    text-align: center;
    ---display: none;
    ---width: 672px; /* Plus 2 x 20px padding  */
    height: 2.5em;
    transition: background-color 0.05s ease;
    color: #000;
}
#result.new {
    --background: #f1c40f;
    background: #d35400;
}
#result.visible {
    ---background: #d35400;
    ---color: #fff;
}
</style>
</head>
<body data-theme="light">
<h1>Master password</h1>
<form onsubmit="generate(); return false;">
    <input
        type="password" id="username"
        placeholder="Master username" required
        autocomplete="off" value="" /><br />
    <input
        type="password" id="password"
        placeholder="Master password" required
        autocomplete="off" /><br />
    <input
        type="password" name="value" id="service"
        placeholder="Service name" required
        autocomplete="off" autofocus />
</form>
<div id="tips">
    Press <code>enter</code> to copy the password
    and <code>alt</code> to reveal it.
</div>
<pre id="result"></pre>

<script>
const sha256 = async (message) => {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    const buffer = await crypto.subtle.digest("SHA-256", data);
    const bytes = Array.from(new Uint8Array(buffer));
    // console.log("Data           ", data);
    // console.log("Buffer         ", buffer);
    // console.log("Bytes          ", bytes);
    // console.log("Encoded?       ", btoa(bytes));
    // console.log("Decoded?       ", buffer);
    // console.log("Hex", hex);
    // console.log("Raw", raw);
    // console.log("+++", btoa(raw));
    // const hex = bytes
    //     .map(b => b.toString(16).padStart(2, "0"))
    //     .join("");

    const raw = String.fromCharCode.apply(String, bytes);
    return raw;
};

const username = document.getElementById("username");
const password = document.getElementById("password");
const service  = document.getElementById("service");
const result   = document.getElementById("result");

let visible  = false;

const save = () => {
    localStorage.setItem("username", username.value);
    localStorage.setItem("password", password.value);
};

const load = () => {
    username.value = localStorage.getItem("username");
    password.value = localStorage.getItem("password");
};

const isKeyboardEmpty = (ev) => {
    return (
        ev.charCode === 0
        && ev.metaKey === false
        && ev.shiftKey === false
        && ev.ctrlKey === false
    )
}

// const onKeyPress = (ev) => {
const onKeyUp = (ev) => {
    if (ev.keyCode === 18 && isKeyboardEmpty(ev)) {
        return toggle(false);
    }

    if (ev.keyCode === 13 && isKeyboardEmpty(ev)) {
        copy();
        return;
    }

    if (!isKeyboardEmpty(ev)) {
        return;
    }

    if (ev.target.id === "service") {
        generate();
        return;
    }
};

const copy = () => {
    const generated = result.getAttribute("data-generated");
    navigator.clipboard.writeText(generated);
    result.innerText = "Password copied to clipboard";
    result.classList.add("new");
    setTimeout(() => {
        result.classList.remove("new");
        result.innerText = result.getAttribute("data-redacted");
    }, 2000);
}

const setValue = (value) => {
    if (value === "") {
        result.setAttribute("data-redacted", value);
        result.setAttribute("data-generated", value);
        result.innerText = "(Empty service name)";
    } else {
        const redacted = value.slice(0, 2) + "****-******-******-******-******-****" + value.slice(-2);
        result.setAttribute("data-redacted", redacted);
        result.setAttribute("data-generated", value);
        result.innerText = redacted;
    }
}

const onKeyDown = (ev) => {
    if (ev.keyCode === 18 && isKeyboardEmpty(ev)) {
        return toggle(true);
    }
};

const generate = () => {
    if (service.value === "") {
        setValue("");
        return;
    }

    save();
    const source = [username.value, password.value, service.value, 0].join(":");
    sha256(source).then(raw => {
        // console.log("Source   ", source);
        // console.log("Raw      ", raw);
        // console.log("Encoded  ", encoded);
        // console.log("Replaced ", replaced);
        // console.log("Parts    ", parts);
        // console.log("Generated", generated);

        const encoded = btoa(raw);
        const regex = /[^0-9A-Za-z]/g;
        const replaced = encoded.replace(regex, "");
        const chunks = 6;
        const length = 6;
        let parts = [];
        for (let i = 0; i < chunks; i++) {
            parts.push(replaced.slice(i * length, (i + 1) * length));
        }
        const generated = parts.join("-");
        setValue(generated);
    })
    .catch(err => {
        console.error("err", err);
    });
};

const toggle = (state) => {
    if (state !== undefined) {
        visible = state;
    }

    if (visible) {
        result.innerText = result.getAttribute("data-generated");
        result.classList.add("visible");
    } else {
        result.innerText = result.getAttribute("data-redacted");
        result.classList.remove("visible");
    }
    visible = !visible;
};

document.onkeydown = onKeyDown;
document.onkeyup = onKeyUp;

load();
</script>
</body>
</html>
